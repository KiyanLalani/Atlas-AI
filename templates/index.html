<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-indigo-600">Atlas AI Assistant</h1>
        
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
            <!-- File Upload Section -->
            <div class="mb-8 p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">Upload Files</h2>
                <form id="file-form" class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <input 
                            type="file" 
                            id="file-input" 
                            class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-semibold
                                file:bg-indigo-50 file:text-indigo-600
                                hover:file:bg-indigo-100"
                            accept=".txt,.pdf,.doc,.docx,.csv,.json"
                        >
                        <button
                            type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            Upload
                        </button>
                    </div>
                    <div id="uploaded-files" class="text-sm text-gray-600"></div>
                    <div id="file-preview" class="mt-4 p-4 bg-gray-50 rounded-md hidden">
                        <h3 class="font-semibold text-gray-700 mb-2">File Preview:</h3>
                        <div id="file-content" class="text-sm text-gray-600 whitespace-pre-wrap max-h-40 overflow-y-auto"></div>
                    </div>
                </form>
            </div>

            <!-- Chat History -->
            <div class="mb-8 h-96 overflow-y-auto p-4 space-y-4 border rounded-lg bg-gray-50" id="chat-history">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Form -->
            <form id="chat-form" class="space-y-4">
                <div class="space-y-2">
                    <label for="user-input" class="block text-sm font-medium text-gray-700">Your message:</label>
                    <textarea
                        id="user-input"
                        name="user_input"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        required
                    ></textarea>
                </div>
                <button
                    type="submit"
                    class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                >
                    Send Message
                </button>
            </form>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let currentFile = null;

        function addMessageToHistory(message, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg ${isUser ? 'bg-indigo-100 ml-8' : 'bg-white mr-8'} mb-2`;
            messageDiv.innerHTML = `
                <div class="font-semibold text-sm text-gray-600 mb-1">${isUser ? 'You' : 'Atlas AI'}</div>
                <div class="text-gray-800 whitespace-pre-wrap">${message}</div>
            `;
            document.getElementById('chat-history').appendChild(messageDiv);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = document.getElementById('user-input').value;
            const submitButton = e.target.querySelector('button');
            
            if (!userInput.trim()) return;

            submitButton.disabled = true;
            addMessageToHistory(userInput, true);
            
            try {
                const response = await fetch('./generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        prompt: userInput,
                        history: conversationHistory,
                        filename: currentFile
                    }),
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessageToHistory(data.response, false);
                    conversationHistory.push({ role: "user", content: userInput });
                    conversationHistory.push({ role: "assistant", content: data.response });
                } else {
                    addMessageToHistory('An error occurred: ' + data.error, false);
                }
            } catch (error) {
                addMessageToHistory('An error occurred. Please try again.', false);
                console.error('Error:', error);
            } finally {
                submitButton.disabled = false;
                document.getElementById('user-input').value = '';
            }
        });

        document.getElementById('file-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const uploadButton = e.target.querySelector('button');
            const uploadedFilesDiv = document.getElementById('uploaded-files');
            
            if (!file) {
                uploadedFilesDiv.textContent = 'Please select a file first';
                uploadedFilesDiv.className = 'text-sm text-red-600';
                return;
            }

            // Show loading state
            uploadButton.disabled = true;
            uploadedFilesDiv.textContent = 'Uploading...';
            uploadedFilesDiv.className = 'text-sm text-gray-600';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('./upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    currentFile = data.filename;
                    uploadedFilesDiv.textContent = `Uploaded: ${file.name}`;
                    uploadedFilesDiv.className = 'text-sm text-green-600';
                    addMessageToHistory(`File uploaded: ${file.name}`, true);
                    
                    // Show file preview
                    const previewDiv = document.getElementById('file-preview');
                    const contentDiv = document.getElementById('file-content');
                    contentDiv.textContent = data.content;
                    previewDiv.classList.remove('hidden');
                    
                    // Add system message about the file
                    addMessageToHistory("I've processed your file. You can now ask questions about its contents.", false);
                    
                    // Clear file input
                    fileInput.value = '';
                } else {
                    uploadedFilesDiv.textContent = `Error: ${data.error}`;
                    uploadedFilesDiv.className = 'text-sm text-red-600';
                    console.error('Upload error:', data.error);
                    if (data.traceback) {
                        console.error('Error traceback:', data.traceback);
                    }
                }
            } catch (error) {
                uploadedFilesDiv.textContent = 'Error uploading file. Please try again.';
                uploadedFilesDiv.className = 'text-sm text-red-600';
                console.error('Upload error:', error);
            } finally {
                uploadButton.disabled = false;
            }
        });
    </script>
</body>
</html> 